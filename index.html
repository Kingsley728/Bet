<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Football Bet Predictor AI with Sportmonks Live Data</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  body {
    margin: 0;
    background: linear-gradient(135deg, #0f4c75, #3282b8);
    font-family: 'Montserrat', sans-serif;
    color: #dbe9f4;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
    padding: 12px;
  }
  h1 {
    margin: 15px 0 10px 0;
    font-weight: 700;
    font-size: 1.9rem;
    letter-spacing: 1.8px;
    text-align: center;
    color: #caf0f8;
    text-shadow: 0 0 6px #90e0ef;
  }
  #predict-btn {
    background-color: #00b7c2;
    color: #072227;
    border: none;
    border-radius: 10px;
    padding: 16px 32px;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 6px 10px #00b7c2aa;
    transition: background-color 0.3s ease;
    user-select: none;
    margin-bottom: 24px;
    width: 90%;
    max-width: 350px;
  }
  #predict-btn:hover {
    background-color: #037d8c;
    color: #caf0f8;
  }
  #loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(15,76,117,0.95);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    visibility: hidden;
  }
  #loading-overlay.visible {
    visibility: visible;
  }
  .loading-box {
    background-color: #145374;
    padding: 30px 50px;
    border-radius: 16px;
    box-shadow: 0 6px 20px #00b7c2cc;
    font-size: 1.2rem;
    font-weight: 700;
    text-align: center;
    color: #caf0f8;
  }
  #error-msg {
    color: #ff5252;
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 16px;
    text-align: center;
  }
  #predictions-container {
    width: 100%;
    max-width: 360px;
    background: #193549cc;
    border-radius: 14px;
    padding: 22px 24px;
    box-shadow: 0 10px 30px #00b7c2aa;
    box-sizing: border-box;
    user-select: none;
    color: #dbe9f4;
    margin-bottom: 20px;
    max-height: 500px;
    overflow-y: auto;
  }
  .match-card {
    background: #1f628d;
    border-radius: 12px;
    margin-bottom: 14px;
    padding: 18px 22px;
    box-shadow: 0 3px 12px #00b7c233;
    transition: background-color 0.35s ease;
  }
  .match-card:hover {
    background-color: #293f6d;
  }
  .match-header {
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 8px;
    color: #a1c4d9;
  }
  .match-teams {
    font-weight: 800;
    font-size: 1.3rem;
    color: #caf0f8;
  }
  .betting-choice {
    margin-top: 10px;
    font-weight: 700;
    font-size: 1.05rem;
    color: #90e0ef;
  }
  .odds {
    margin-top: 4px;
    font-weight: 800;
    font-size: 1.1rem;
    color: #00b7c2;
  }
  .confidence {
    font-weight: 600;
    font-size: 0.95rem;
    color: #95d5b2;
    margin-top: 6px;
  }
  #saved-bets-container {
    margin-top: 10px;
    width: 100%;
    max-width: 360px;
    background: #193549cc;
    border-radius: 14px;
    padding: 18px 22px;
    box-sizing: border-box;
    box-shadow: 0 10px 30px #54d3c9aa;
    color: #ade8f4;
    font-weight: 700;
    margin-bottom: 24px;
    max-height: 280px;
    overflow-y: auto;
  }
  #saved-bets-container h2 {
    margin-top: 0; margin-bottom: 14px;
    text-align: center;
    text-shadow: 0 0 5px #90e0ef;
  }
  .saved-bet {
    position: relative;
    border: 1.7px solid #54d3c9;
    margin-bottom: 12px;
    border-radius: 10px;
    padding: 12px 40px 12px 16px;
    background: #14919ccc;
    box-shadow: 0 4px 15px #54d3c999;
  }
  .saved-bet-header {
    font-weight: 800;
    font-size: 1.1rem;
    margin-bottom: 6px;
  }
  .saved-bet-odds {
    font-weight: 800;
    color: #80ffe1;
  }
  .btn-delete {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 1.2rem;
    font-weight: 900;
    color: #ff6b6b;
    cursor: pointer;
    user-select: none;
    line-height: 1;
    padding: 0;
    transition: color 0.25s ease;
  }
  .btn-delete:hover {
    color: #ff1f1f;
  }
  .btn-save {
    background-color: #00b7c2;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    font-weight: 700;
    font-size: 1rem;
    color: #072227;
    cursor: pointer;
    user-select: none;
    margin-top: 12px;
    width: 100%;
    box-shadow: 0 5px 15px #00b7c2cc;
    transition: background-color 0.25s ease;
  }
  .btn-save:hover:not(:disabled) {
    background-color: #037d8c;
    color: #caf0f8;
  }
  .btn-save:disabled {
    background-color: #4178a8;
    cursor: default;
    box-shadow: none;
    color: #dbe9f4;
  }
  @media (max-width: 600px) {
    body {
      padding: 10px;
    }
    #predict-btn {
      width: 100%;
      max-width: 100%;
    }
    #predictions-container, #saved-bets-container {
      max-width: 100%;
      padding: 18px 16px;
    }
  }
</style>
</head>
<body>
  <h1>Football Bet Predictor AI with Sportmonks Data</h1>
  <button id="predict-btn" aria-label="Generate Football Betting Predictions">Predict Matches</button>
  <div id="loading-overlay" role="alert" aria-live="assertive" aria-busy="true">
    <div class="loading-box">Fetching live data and calculating predictions... Please wait</div>
  </div>
  <div id="error-msg" role="alert" aria-live="assertive" style="display:none"></div>
  <div id="predictions-container" aria-live="polite" aria-atomic="true" tabindex="0" aria-label="Predicted football matches and bets"></div>
  <div id="saved-bets-container" aria-live="polite" aria-atomic="true" tabindex="0" aria-label="Saved football bets">
    <h2>Saved Bets</h2>
    <div id="saved-bets-list"><em>No saved bets yet.</em></div>
  </div>

<script>
(() => {
  'use strict';

  const API_KEY = 'Nj9zJbCuMVOlHZrVaKHAG6ffdlKjhS8hjZcQ7NzAOm368sZB7PZxMzNtUnRM';
  // The example endpoint gives round 339328 with included fixtures, odds, and bookmakers.
  const API_ENDPOINT = \`https://api.sportmonks.com/v3/football/rounds/339328?include=fixtures.odds.market;fixtures.odds.bookmaker;fixtures.participants;league.country&filters=markets:1;bookmakers:2&api_token=\${API_KEY}\`;

  // Cache saved bets key
  const STORAGE_KEY = 'savedBetsSportmonks';

  function formatMatchDate(date) {
    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return \`\${days[date.getDay()]}, \${months[date.getMonth()]} \${date.getDate()}, \${date.getHours().toString().padStart(2,'0')}:\${date.getMinutes().toString().padStart(2,'0')}\`;
  }

  function showLoading(show) {
    const overlay = document.getElementById('loading-overlay');
    if (show) overlay.classList.add('visible');
    else overlay.classList.remove('visible');
  }

  function showError(msg) {
    const errEl = document.getElementById('error-msg');
    if (msg) {
      errEl.style.display = 'block';
      errEl.textContent = msg;
    } else {
      errEl.style.display = 'none';
      errEl.textContent = '';
    }
  }

  function saveBetsToStorage(bets) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
  }

  function loadSavedBets() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return [];
    try {
      return JSON.parse(data);
    } catch {
      return [];
    }
  }

  function formatSavedBet(bet, index) {
    const dateStr = new Date(bet.matchDate).toLocaleString();
    return \`
    <div class="saved-bet" tabindex="0" role="listitem" aria-label="Saved bet \${bet.betChoice} for match \${bet.home} versus \${bet.away} on \${dateStr} with odds \${bet.odds}">
      <div class="saved-bet-header">\${bet.home} vs \${bet.away}</div>
      <div>Bet: \${bet.betChoice} | Odds: <span class="saved-bet-odds">\${bet.odds.toFixed(2)}</span></div>
      <div>Kickoff: \${formatMatchDate(new Date(bet.matchDate))}</div>
      <button class="btn-delete" aria-label="Delete saved bet" data-index="\${index}" title="Delete saved bet">‚ùå</button>
    </div>\`;
  }

  function renderSavedBets() {
    const container = document.getElementById('saved-bets-list');
    const savedBets = loadSavedBets();
    if (savedBets.length === 0) {
      container.innerHTML = '<em>No saved bets yet.</em>';
      return;
    }
    container.innerHTML = '';
    savedBets.forEach((bet, idx) => {
      container.insertAdjacentHTML('beforeend', formatSavedBet(bet, idx));
    });
    container.querySelectorAll('.btn-delete').forEach(button => {
      button.onclick = () => {
        const index = Number(button.dataset.index);
        let bets = loadSavedBets();
        bets.splice(index, 1);
        saveBetsToStorage(bets);
        renderSavedBets();
      };
    });
  }

  function generateConfidence() {
    return Math.floor(Math.random() * 15) + 85; // 85 to 99%
  }

  // Select one bet type from known safer market (1X2)
  function chooseBetAndOdds(oddsData) {
    // oddsData format: {market, bookmaker, outcomes[]}
    // Outcomes usually: home, draw, away with price and name

    // We'll pick one outcome with odds between 1.5 and 1.99 trying safer bets
    let safeOutcomes = oddsData.filter(o => o.price >= 1.5 && o.price <= 1.99);
    if (safeOutcomes.length === 0) safeOutcomes = oddsData; // fallback all

    // Choose random safe outcome
    const chosen = safeOutcomes[Math.floor(Math.random() * safeOutcomes.length)];
    return chosen;
  }

  function formatPredictionCard(prediction, index) {
    const dateStr = formatMatchDate(new Date(prediction.matchDate));
    return `
      <div class="match-card" tabindex="0" aria-label="Match ${prediction.home} versus ${prediction.away} on ${dateStr}. Recommended bet: ${prediction.betChoice} with odds ${prediction.odds.toFixed(2)}. Confidence ${prediction.confidence}%">
        <div class="match-header">
          <div class="match-teams">${prediction.home} vs ${prediction.away}</div>
          <div>${dateStr}</div>
        </div>
        <div class="betting-choice">Bet: ${prediction.betChoice}</div>
        <div class="odds">Odds: ${prediction.odds.toFixed(2)}</div>
        <div class="confidence">Confidence: ${prediction.confidence}%</div>
        <button class="btn-save" aria-label="Save this bet" data-index="${index}">Save Bet</button>
      </div>
    `;
  }

  function renderPredictions(predictions) {
    const container = document.getElementById('predictions-container');
    container.innerHTML = '';
    predictions.forEach((p, i) => {
      container.insertAdjacentHTML('beforeend', formatPredictionCard(p, i));
    });
    // Bind save buttons
    container.querySelectorAll('.btn-save').forEach(button => {
      button.disabled = false;
      button.textContent = 'Save Bet';
      button.onclick = () => {
        const idx = Number(button.dataset.index);
        let savedBets = loadSavedBets();
        // Avoid duplicate saving
        if (!savedBets.some(b =>
          b.home === predictions[idx].home &&
          b.away === predictions[idx].away &&
          b.betChoice === predictions[idx].betChoice
        )) {
          savedBets.push(predictions[idx]);
          saveBetsToStorage(savedBets);
          renderSavedBets();
          button.disabled = true;
          button.textContent = 'Saved';
        }
      };
    });
  }

  async function fetchAndPredict() {
    showError('');
    showLoading(true);
    try {
      const response = await fetch(API_ENDPOINT);
      if (!response.ok) {
        throw new Error('Failed to fetch data from Sportmonks API');
      }
      const data = await response.json();
      if (!data || !data.data || !data.data.fixtures || data.data.fixtures.length === 0) {
        throw new Error('No fixtures data available');
      }

      // Extract fixtures array
      const fixtures = data.data.fixtures.data;

      // Filter fixtures with odds and markets included
      const fixturesWithOdds = fixtures.filter(fixture =>
        fixture.odds && fixture.odds.data && fixture.odds.data.length > 0);

      if (fixturesWithOdds.length === 0) throw new Error('No fixtures with odds found');

      // Select 5 to 8 fixtures randomly
      const count = Math.min(8, fixturesWithOdds.length);
      const chosenFixtures = [];
      const usedIndices = new Set();

      while(chosenFixtures.length < count) {
        const idx = Math.floor(Math.random() * fixturesWithOdds.length);
        if (usedIndices.has(idx)) continue;
        usedIndices.add(idx);
        chosenFixtures.push(fixturesWithOdds[idx]);
      }

      // For each fixture, find 1X2 market (market id: 1 per your link) and bookmaker (id: 2) odds
      // Choose one bet and odds according to safer odds between 1.5 to 1.99 if possible
      const predictions = chosenFixtures.map(fixture => {
        let oddsMarket = fixture.odds.data.find(market => market.market_id === 1);
        if (!oddsMarket || !oddsMarket.bookmakers || oddsMarket.bookmakers.length === 0) {
          // fallback: any odds
          oddsMarket = fixture.odds.data[0];
        }
        // Bookmaker id 2 is preferred, else take first bookmaker
        let bookmakerOdds = oddsMarket.bookmakers.find(bk => bk.bookmaker_id === 2);
        if (!bookmakerOdds) {
          bookmakerOdds = oddsMarket.bookmakers[0];
        }

        let chosenOutcome = chooseBetAndOdds(bookmakerOdds.outcomes);

        return {
          home: fixture.localTeam.data.name,
          away: fixture.visitorTeam.data.name,
          matchDate: fixture.time.starting_at.date_time,
          betChoice: chosenOutcome.name,
          odds: chosenOutcome.price,
          confidence: generateConfidence()
        };
      });

      renderPredictions(predictions);

    } catch (e) {
      showError(e.message || 'An error occurred while fetching data.');
      document.getElementById('predictions-container').innerHTML = '';
    } finally {
      showLoading(false);
    }
  }

  function init() {
    renderSavedBets();
    const btn = document.getElementById('predict-btn');
    btn.addEventListener('click', fetchAndPredict);
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>

